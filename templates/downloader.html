{% extends "base.html" %}

{% block title %}Pengunduh Media - Universal Toolkit{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Pengunduh Media</h1>
    <p class="page-subtitle">Unduh video, audio, dan galeri dari berbagai platform dengan yt-dlp dan gallery-dl</p>
</div>

<div class="tools-grid">
    <!-- Video Download -->
    <div class="tool-card">
        <div class="tool-card-header">
            <div class="tool-icon">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2zm13 2.383-4.758 2.855L15 11.114v-5.73zm-.034 6.878L9.271 8.82 8 9.583 6.728 8.82l-5.694 3.44A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.739zM1 11.114l4.758-2.876L1 5.383v5.73z"/>
                </svg>
            </div>
            <h3 class="tool-title">Unduh Video</h3>
        </div>
        <p class="tool-description">
            Unduh video dari YouTube, TikTok, Instagram, Facebook, dan platform lainnya
        </p>
        
        <form class="toolkit-form" id="videoDownloadForm">
            <div class="form-group">
                <label class="form-label" for="videoUrl">URL Video:</label>
                <input type="text" id="videoUrl" class="form-input" placeholder="https://youtube.com/watch?v=..." required>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="videoFormat">Format Output:</label>
                <select id="videoFormat" class="form-select">
                    <option value="mp4">MP4 (Video)</option>
                    <option value="webm">WebM (Video)</option>
                    <option value="mkv">MKV (Video)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="videoQuality">Kualitas:</label>
                <select id="videoQuality" class="form-select">
                    <option value="best">Kualitas Terbaik</option>
                    <option value="2160p">4K (2160p)</option>
                    <option value="1440p">1440p (2K)</option>
                    <option value="1080p">1080p HD</option>
                    <option value="720p">720p HD</option>
                    <option value="480p">480p SD</option>
                    <option value="360p">360p</option>
                </select>
            </div>
            
            <button type="submit" class="btn">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
                Unduh Video
            </button>
        </form>
        
        <div class="progress-container" id="videoProgressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="videoProgressFill"></div>
            </div>
            <div class="progress-text" id="videoProgressText">Mempersiapkan unduhan...</div>
        </div>
        
        <div class="result-container" id="videoResultContainer">
            <div class="result-title" id="videoResultTitle"></div>
            <div class="result-message" id="videoResultMessage"></div>
            <a href="#" id="videoDownloadLink" class="btn" style="display: none;">Unduh File</a>
        </div>
    </div>

    <!-- Audio Download -->
    <div class="tool-card">
        <div class="tool-card-header">
            <div class="tool-icon">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M9 13c0 1.105-1.12 2-2.5 2S4 14.105 4 13s1.12-2 2.5-2 2.5.895 2.5 2z"/>
                    <path fill-rule="evenodd" d="M9 3v10H8V3h1z"/>
                    <path d="M8 2.82a1 1 0 0 1 .804-.98l3-.6A1 1 0 0 1 13 2.22V4L8 5V2.82z"/>
                </svg>
            </div>
            <h3 class="tool-title">Unduh Audio</h3>
        </div>
        <p class="tool-description">
            Unduh audio saja dari video dengan kualitas tinggi
        </p>
        
        <form class="toolkit-form" id="audioDownloadForm">
            <div class="form-group">
                <label class="form-label" for="audioUrl">URL Video/Audio:</label>
                <input type="text" id="audioUrl" class="form-input" placeholder="https://youtube.com/watch?v=..." required>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="audioFormat">Format Audio:</label>
                <select id="audioFormat" class="form-select">
                    <option value="mp3">MP3</option>
                    <option value="opus">Opus</option>
                    <option value="m4a">M4A</option>
                    <option value="aac">AAC</option>
                    <option value="flac">FLAC</option>
                    <option value="ogg">OGG</option>
                    <option value="wav">WAV</option>
                    <option value="webm">WebM Audio</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="audioQuality">Kualitas Audio:</label>
                <select id="audioQuality" class="form-select">
                    <option value="320">320 kbps (Terbaik)</option>
                    <option value="192">192 kbps (Baik)</option>
                    <option value="128">128 kbps (Standar)</option>
                    <option value="96">96 kbps (Hemat)</option>
                </select>
            </div>
            
            <button type="submit" class="btn">Unduh Audio</button>
        </form>
        
        <div class="progress-container" id="audioProgressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="audioProgressFill"></div>
            </div>
            <div class="progress-text" id="audioProgressText">Mempersiapkan unduhan audio...</div>
        </div>
        
        <div class="result-container" id="audioResultContainer">
            <div class="result-title" id="audioResultTitle"></div>
            <div class="result-message" id="audioResultMessage"></div>
            <a href="#" id="audioDownloadLink" class="btn" style="display: none;">Unduh File Audio</a>
        </div>
    </div>

    <!-- Platform Support Info -->
    <div class="tool-card">
        <div class="tool-card-header">
            <div class="tool-icon">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm7.5-6.923c-.67.204-1.335.82-1.887 1.855A7.97 7.97 0 0 0 5.145 4H7.5V1.077zM4.09 4a9.267 9.267 0 0 1 .64-1.539 6.7 6.7 0 0 1 .597-.933A7.025 7.025 0 0 0 2.255 4H4.09zm-.582 3.5c.03-.877.138-1.718.312-2.5H1.674a6.958 6.958 0 0 0-.656 2.5h2.49zM4.847 5a12.5 12.5 0 0 0-.338 2.5H7.5V5H4.847zM8.5 5v2.5h2.99a12.495 12.495 0 0 0-.337-2.5H8.5zM4.51 8.5a12.5 12.5 0 0 0 .337 2.5H7.5V8.5H4.51zm3.99 0V11h2.653c.187-.765.306-1.608.338-2.5H8.5zM5.145 12c.138.386.295.744.468 1.068.552 1.035 1.218 1.65 1.887 1.855V12H5.145zm.182 2.472a6.696 6.696 0 0 1-.597-.933A9.268 9.268 0 0 1 4.09 12H2.255a7.024 7.024 0 0 0 3.072 2.472zM3.82 11a13.652 13.652 0 0 1-.312-2.5h-2.49c.062.89.291 1.733.656 2.5H3.82zm6.853 3.472A7.024 7.024 0 0 0 13.745 12H11.91a9.27 9.27 0 0 1-.64 1.539 6.688 6.688 0 0 1-.597.933zM8.5 12v2.923c.67-.204 1.335-.82 1.887-1.855.173-.324.33-.682.468-1.068H8.5zm3.68-1h2.146c.365-.767.594-1.61.656-2.5h-2.49a13.65 13.65 0 0 1-.312 2.5zm.312-3.5h2.49c-.062-.89-.291-1.733-.656-2.5H12.18c.174.782.282 1.623.312 2.5zM11.27 2.461c.247.464.462.98.64 1.539h1.835a7.024 7.024 0 0 0-3.072-2.472c.218.284.418.598.597.933zM10.855 4a7.966 7.966 0 0 0-.468-1.068C9.835 1.897 9.17 1.282 8.5 1.077V4h2.355z"/>
                </svg>
            </div>
            <h3 class="tool-title">Platform yang Didukung</h3>
        </div>
        <p class="tool-description">
            Kami mendukung unduhan dari platform berikut:
        </p>
        <div style="margin-top: 16px;">
            <span class="btn btn-secondary btn-small">YouTube</span>
            <span class="btn btn-secondary btn-small">TikTok</span>
            <span class="btn btn-secondary btn-small">Instagram</span>
            <span class="btn btn-secondary btn-small">Facebook</span>
            <span class="btn btn-secondary btn-small">Twitter</span>
            <span class="btn btn-secondary btn-small">Vimeo</span>
            <span class="btn btn-secondary btn-small">Dan lainnya...</span>
        </div>
    </div>

    <!-- Tips -->
    <div class="tool-card">
        <div class="tool-card-header">
            <div class="tool-icon">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                </svg>
            </div>
            <h3 class="tool-title">Tips & Panduan</h3>
        </div>
        <div class="tool-description">
            <ul style="margin-left: 20px; line-height: 1.8;">
                <li><strong>Konten Publik Saja:</strong> Hanya unduh konten yang tersedia publik dan hormati hak cipta</li>
                <li><strong>Opsi Kualitas:</strong> Format video mengunduh dengan kualitas terbaik, audio mengekstrak pada 192kbps</li>
                <li><strong>Waktu Pemrosesan:</strong> Waktu unduhan tergantung pada durasi dan kualitas video</li>
                <li><strong>Format Didukung:</strong> MP4 untuk video, MP3 untuk ekstraksi audio</li>
                <li><strong>Ukuran File:</strong> File besar mungkin memerlukan waktu lebih lama untuk diproses dan diunduh</li>
            </ul>
        </div>
    </div>
</div>

<script>
// Downloader JavaScript dengan dukungan bahasa Indonesia
class UniversalDownloader {
    constructor() {
        this.initializeEventListeners();
    }

    initializeEventListeners() {
        document.getElementById('videoDownloadForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleVideoDownload();
        });

        document.getElementById('audioDownloadForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleAudioDownload();
        });
    }

    async handleVideoDownload() {
        const url = document.getElementById('videoUrl').value;
        const format = document.getElementById('videoFormat').value;
        const quality = document.getElementById('videoQuality').value;

        await this.performDownload('/api/download/video', {
            url, format, quality
        }, 'video');
    }

    async handleAudioDownload() {
        const url = document.getElementById('audioUrl').value;
        const format = document.getElementById('audioFormat').value;
        const quality = document.getElementById('audioQuality').value;

        await this.performDownload('/api/download/audio', {
            url, format, quality
        }, 'audio');
    }

    async performDownload(endpoint, payload, type) {
        const progressContainer = document.getElementById(`${type}ProgressContainer`);
        const progressFill = document.getElementById(`${type}ProgressFill`);
        const progressText = document.getElementById(`${type}ProgressText`);
        const resultContainer = document.getElementById(`${type}ResultContainer`);
        const downloadLink = document.getElementById(`${type}DownloadLink`);

        progressContainer.style.display = 'block';
        resultContainer.style.display = 'none';

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            
            if (data.task_id) {
                this.trackProgress(data.task_id, type);
            } else {
                this.showError(`${type}ResultContainer`, data.error);
            }
        } catch (error) {
            this.showError(`${type}ResultContainer`, 'Terjadi kesalahan saat memulai unduhan');
        }
    }

    trackProgress(taskId, type) {
        const progressFill = document.getElementById(`${type}ProgressFill`);
        const progressText = document.getElementById(`${type}ProgressText`);
        const resultContainer = document.getElementById(`${type}ResultContainer`);
        const downloadLink = document.getElementById(`${type}DownloadLink`);

        const pollProgress = async () => {
            try {
                const response = await fetch(`/api/progress/${taskId}`);
                const progress = await response.json();

                progressFill.style.width = `${progress.progress}%`;
                progressText.textContent = progress.message;

                if (progress.status === 'completed') {
                    document.getElementById(`${type}ProgressContainer`).style.display = 'none';
                    resultContainer.style.display = 'block';
                    resultContainer.className = 'result-container success';
                    document.getElementById(`${type}ResultTitle`).textContent = 'Berhasil!';
                    document.getElementById(`${type}ResultMessage`).textContent = progress.message;
                    downloadLink.href = `/download/${taskId}`;
                    downloadLink.style.display = 'inline-flex';
                } else if (progress.status === 'error') {
                    this.showError(`${type}ResultContainer`, progress.message);
                } else {
                    setTimeout(pollProgress, 1000);
                }
            } catch (error) {
                this.showError(`${type}ResultContainer`, 'Terjadi kesalahan saat melacak progres');
            }
        };

        pollProgress();
    }

    showError(containerId, message) {
        const container = document.getElementById(containerId);
        container.style.display = 'block';
        container.className = 'result-container error';
        const titleEl = container.querySelector('.result-title');
        const messageEl = container.querySelector('.result-message');
        if (titleEl) titleEl.textContent = 'Error';
        if (messageEl) messageEl.textContent = message;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new UniversalDownloader();
});
</script>
{% endblock %}